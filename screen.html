<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>FarmQuest</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif;}
body { min-height:100vh; background:linear-gradient(to top,#7ec850,#c9f2a6); display:flex; align-items:center; justify-content:center; }

/* –û–ë–©–ò–ï –≠–ö–†–ê–ù–´ */
.screen { background:rgba(255,255,255,0.95); padding:30px; border-radius:25px; box-shadow:0 15px 40px rgba(0,0,0,0.25); width:95%; max-width:1100px; animation:fadeIn 0.8s ease; }
.hidden { display:none; }

/* –ú–æ–¥–∞–ª–∫–∏ –ø–æ id */
#registerModal, #loginModal, #minigameModal { display:none; }
#registerModal.show, #loginModal.show, #minigameModal.show { display:flex; }

/* ====== –ú–ï–ù–Æ ====== */
.menu { max-width:420px; text-align:center; margin:0 auto; }
.menu h1 { font-size:48px; color:#4b8b3b; }
.menu h1 span { color:#f4a261; }
.menu p { margin:15px 0 15px; color:#555; }

.menu .current-user {
  font-size:14px;
  color:#555;
  margin-bottom:10px;
}
.menu .current-user span {
  font-weight:600;
  color:#4b8b3b;
}

.btn {
  width:100%;
  padding:15px;
  margin:8px 0;
  border:none;
  border-radius:15px;
  font-size:18px;
  cursor:pointer;
  transition:0.3s;
}
.btn-start { background:#4b8b3b; color:#fff; }
.btn-start:hover { background:#3a6e2c; transform:scale(1.05);}
.btn-secondary { background:#f4a261; color:#fff; }
.btn-secondary:hover { background:#e76f51; transform:scale(1.05); }

/* –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ */
.btn-logout {
  background:#bdbdbd;
  color:#333;
  font-size:14px;
  padding:8px 15px;
  width:auto;
  margin-top:4px;
  border-radius:12px;
}
.btn-logout:hover { background:#9e9e9e; }

/* ====== –ë–ê–ó–ê –ü–ï–†–°–û–ù–ê–ñ–ï–ô ====== */
.db h1 { text-align:center; font-size:40px; color:#4b8b3b; }
.db h1 span { color:#f4a261; }
.db p { text-align:center; color:#555; margin-bottom:10px; }
.db .hint { text-align:center; color:#777; font-size:14px; margin-bottom:15px; }

.user-info {
  text-align:center;
  margin-bottom:15px;
  font-size:14px;
  color:#444;
}
.user-info span { font-weight:600; }

.form { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:20px; }
input { padding:12px; border-radius:12px; border:1px solid#ccc; font-size:15px; }

table { width:100%; border-collapse:collapse; margin-top:15px;}
th,td { padding:10px; border-bottom:1px solid #ddd; text-align:center;}
th { background:#e9f5e3; color:#4b8b3b; }
.btn-add { background:#4b8b3b; color:#fff; }
.btn-add:hover { background:#3a6e2c; transform:scale(1.05);}
.btn-delete { background:#e76f51; color:#fff; padding:8px 12px; border-radius:10px; border:none; cursor:pointer; }
.btn-delete:hover { background:#d65a3c; }
.btn-back { margin-top:20px; background:#bdbdbd; color:#333; }
.btn-back:hover { background:#9e9e9e; }

tr.selected-row { background:#ffe0b2; }

/* ====== –≠–ö–†–ê–ù –ò–ì–†–´: –ö–ê–†–¢–ê + –§–ï–†–ú–´ ====== */
.game-layout {
  display:grid;
  grid-template-columns:1.1fr 1.5fr;
  gap:20px;
}

/* –ö–ê–†–¢–ê */
.map-panel {
  border-radius:20px;
  background:#f2f8ec;
  padding:15px;
}
.map-panel h2 {
  text-align:center;
  font-size:22px;
  color:#4b8b3b;
  margin-bottom:8px;
}
.map-subtitle {
  text-align:center;
  font-size:13px;
  color:#777;
  margin-bottom:10px;
}
.map-grid {
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:12px;
}
.map-tile {
  background:#ffffff;
  border-radius:18px;
  padding:14px 10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  transition:0.2s;
}
.map-tile span.icon {
  font-size:28px;
  margin-bottom:6px;
}
.map-tile-title {
  font-size:15px;
  font-weight:600;
  color:#4b8b3b;
}
.map-tile-desc {
  font-size:12px;
  color:#777;
  text-align:center;
  margin-top:3px;
}
.map-tile.active {
  outline:2px solid #4b8b3b;
  transform:translateY(-2px);
}
.map-tile:hover { transform:translateY(-3px); }

/* –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ */
.detail-panel {
  border-radius:20px;
  background:#fdfdfd;
  padding:15px;
}
.detail-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.detail-header h2 { font-size:22px; color:#4b8b3b; }
.detail-header small { font-size:12px; color:#777; }
.balance { font-size:14px; color:#4b8b3b; }

/* –≤–∫–ª–∞–¥–∫–∏ */
.detail-tabs {
  display:flex;
  gap:8px;
  margin-bottom:10px;
}
.detail-tab {
  flex:1;
  text-align:center;
  padding:8px;
  border-radius:12px;
  font-size:14px;
  cursor:pointer;
  background:#e9f5e3;
  color:#4b8b3b;
  transition:0.2s;
}
.detail-tab.active {
  background:#4b8b3b;
  color:#fff;
}

.detail-content { min-height:260px; }

/* –§–ï–†–ú–´ */
.farms-wrapper { display:flex; flex-direction:column; gap:16px; }
.single-farm {
  border-radius:16px;
  background:#f7fbf4;
  padding:10px;
}
.single-farm-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}
.single-farm-title {
  font-size:14px;
  font-weight:600;
  color:#4b8b3b;
}
.single-farm-tools {
  font-size:11px;
  color:#555;
  text-align:right;
}
.farm-grid {
  display:grid;
  grid-template-columns:repeat(3, 70px);
  grid-auto-rows:70px;
  gap:6px;
  justify-content:center;
  margin-top:4px;
}
.tile {
  border-radius:12px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  user-select:none;
  transition:0.2s;
}
.tile.empty  { background:#c8e6c9; }
.tile.tilled { background:#a5d6a7; }
.tile.planted { background:#81c784; }
.tile.ready  { background:#ffeb3b; }
.tile:hover { transform:scale(1.03); }

.locked-farm {
  text-align:center;
  font-size:13px;
  color:#777;
  padding:20px 10px 10px;
}
.locked-farm button {
  margin-top:8px;
  width:auto;
  padding:8px 14px;
  font-size:14px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  background:#4b8b3b;
  color:#fff;
}

/* –ú–ê–ì–ê–ó–ò–ù –°–ï–ú–Ø–ù */
.seeds-shop {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:10px;
  margin-top:5px;
}
.seed-item {
  border-radius:14px;
  padding:10px;
  background:#f7fbf4;
  border:1px solid #e0f2e9;
  display:flex;
  flex-direction:column;
  gap:4px;
  font-size:13px;
}
.seed-header {
  display:flex;
  align-items:center;
  gap:6px;
}
.seed-header span.emoji { font-size:20px; }
.seed-name { font-weight:600; color:#4b8b3b; }
.seed-desc { color:#777; font-size:12px; }
.seed-footer {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:4px;
}
.seed-price { color:#f4a261; font-weight:600; font-size:12px; }
.seed-owned { font-size:11px; color:#388e3c; }
.seed-owned.none { color:#b0b0b0; }
.seed-buy-btn {
  border-radius:10px;
  border:none;
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
  background:#4b8b3b;
  color:#fff;
}
.seed-buy-btn:disabled {
  background:#bdbdbd;
  cursor:default;
}

/* –ú–ê–ì–ê–ó–ò–ù –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í / –¢–ï–•–ù–ò–ö–ò / –ü–û–õ–ï–ô */
.shop-list {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
  gap:10px;
  margin-top:5px;
}
.shop-item {
  border-radius:14px;
  padding:10px;
  background:#f7fbf4;
  border:1px solid #e0f2e9;
  font-size:13px;
  display:flex;
  flex-direction:column;
  gap:4px;
}
.shop-header {
  display:flex;
  align-items:center;
  gap:6px;
}
.shop-header span.emoji { font-size:20px; }
.shop-name { font-weight:600; color:#4b8b3b; }
.shop-desc { color:#777; font-size:12px; }
.shop-footer {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:4px;
}
.shop-price { color:#f4a261; font-weight:600; font-size:12px; }
.shop-owned { font-size:11px; color:#388e3c; }
.shop-owned.none { color:#b0b0b0; }
.shop-buy-btn {
  border-radius:10px;
  border:none;
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
  background:#4b8b3b;
  color:#fff;
}
.shop-buy-btn:disabled {
  background:#bdbdbd;
  cursor:default;
}

/* –ú–ò–ù–ò–ò–ì–†–´ ‚Äì –ü–†–ï–í–¨–Æ */
.minigames-placeholder {
  text-align:center;
  color:#777;
  font-size:14px;
  padding-top:20px;
}
.minigame-card {
  display:inline-block;
  margin-top:10px;
  padding:10px 14px;
  border-radius:12px;
  background:#f7fbf4;
  border:1px solid #e0f2e9;
  font-size:13px;
}

/* CANVAS –ú–ò–ù–ò–ò–ì–† */
.minigame-canvas {
  display:block;
  margin:0 auto;
  border-radius:12px;
  border:1px solid #c5e1a5;
  background:#222;
}
.fish-controls, .carrot-controls {
  display:flex;
  justify-content:center;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.fish-controls button, .carrot-controls button {
  padding:6px 10px;
  border-radius:10px;
  border:none;
  background:#4b8b3b;
  color:#fff;
  font-size:12px;
  cursor:pointer;
}
.minigame-info {
  margin-top:8px;
  font-size:12px;
  color:#555;
}

/* –ú–û–î–ê–õ–ö–ò */
.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal-content {
  background:#fff;
  padding:25px 30px;
  border-radius:20px;
  width:95%;
  max-width:800px;
  box-shadow:0 10px 30px rgba(0,0,0,0.3);
  animation:fadeIn 0.3s ease;
}
.modal-content h2 {
  text-align:center;
  color:#4b8b3b;
  margin-bottom:10px;
}
.modal-content p {
  text-align:center;
  color:#555; margin-bottom:15px;
}
.modal-content form {
  display:flex;
  flex-direction:column;
  gap:10px;
}
.modal-content input { width:100%; }
.modal-btn-group {
  display:flex;
  gap:10px;
  margin-top:10px;
}
.modal-btn-group .btn { flex:1; }
.error-message {
  color:#e53935;
  font-size:14px;
  text-align:center;
  margin-top:5px;
  min-height:20px;
}

/* –ê–ù–ò–ú–ê–¶–ò–Ø */
@keyframes fadeIn { from { opacity:0; transform:translateY(15px);} to { opacity:1; transform:translateY(0);} }
</style>
</head>

<body>

<!-- ====== –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ====== -->
<div class="screen menu" id="menuScreen">
  <h1>Farm<span>Quest</span></h1>
  <p>–†–∞–∑–≤–∏–≤–∞–π —Ñ–µ—Ä–º—É –∏ —É–ø—Ä–∞–≤–ª—è–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏</p>

  <div class="current-user">
    –ê–∫–∫–∞—É–Ω—Ç: <span id="currentUserLabel">–ù–µ –≤–æ—à–ª–∏</span>
  </div>

  <button class="btn btn-start" onclick="startGame()">üå± –í–æ–π—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç—É</button>
  <button class="btn btn-secondary" onclick="showScreen('dbScreen')">üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏</button>
  <button class="btn btn-secondary" onclick="loginAsGuest()">üôã –í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</button>
  <button class="btn btn-secondary" onclick="showLoginModal()">üîë –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</button>
  <button class="btn btn-secondary" onclick="showRegisterModal()">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>

  <button class="btn-logout" onclick="logout()" id="logoutBtn" style="display:none;">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
</div>

<!-- ====== –≠–ö–†–ê–ù –ò–ì–†–´ ====== -->
<div class="screen game hidden" id="gameScreen">
  <div class="game-layout">
    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –∫–∞—Ä—Ç–∞ -->
    <div class="map-panel">
      <h2>–ö–∞—Ä—Ç–∞ —Ñ–µ—Ä–º—ã</h2>
      <p class="map-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é: –ø–æ–ª—è, –º–∞–≥–∞–∑–∏–Ω—ã –∏–ª–∏ –º–∏–Ω–∏–∏–≥—Ä—ã</p>
      <div class="map-grid">
        <div class="map-tile active" data-location="farm" onclick="selectLocation('farm')">
          <span class="icon">üåæ</span>
          <div class="map-tile-title">–ü–æ–ª—è</div>
          <div class="map-tile-desc">–°–∞–∂–∞–π—Ç–µ –∏ —Å–æ–±–∏—Ä–∞–π—Ç–µ —É—Ä–æ–∂–∞–π</div>
        </div>
        <div class="map-tile" data-location="seeds" onclick="selectLocation('seeds')">
          <span class="icon">üå±</span>
          <div class="map-tile-title">–ú–∞–≥–∞–∑–∏–Ω —Å–µ–º—è–Ω</div>
          <div class="map-tile-desc">–ü–æ–∫—É–ø–∫–∞ —Ä–∞–∑–Ω—ã—Ö –∫—É–ª—å—Ç—É—Ä</div>
        </div>
        <div class="map-tile" data-location="tools" onclick="selectLocation('tools')">
          <span class="icon">ü™ì</span>
          <div class="map-tile-title">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
          <div class="map-tile-desc">–ë–æ–Ω—É—Å –∫ —Å–±–æ—Ä—É —É—Ä–æ–∂–∞—è</div>
        </div>
        <div class="map-tile" data-location="equipment" onclick="selectLocation('equipment')">
          <span class="icon">üöú</span>
          <div class="map-tile-title">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</div>
          <div class="map-tile-desc">–†–æ—Å—Ç –∏ –¥–æ–ø. –ø–æ–ª—è</div>
        </div>
        <div class="map-tile" data-location="minigames" onclick="selectLocation('minigames')">
          <span class="icon">üéÆ</span>
          <div class="map-tile-title">–ú–∏–Ω–∏–∏–≥—Ä—ã</div>
          <div class="map-tile-desc">–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –±–æ–Ω—É—Å–Ω—ã–µ –º–æ–Ω–µ—Ç—ã</div>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å -->
    <div class="detail-panel">
      <div class="detail-header">
        <div>
          <h2 id="detailTitle">–ü–æ–ª—è</h2>
          <small>–ü–µ—Ä—Å–æ–Ω–∞–∂: <span id="currentCharLabel">–Ω–µ –≤—ã–±—Ä–∞–Ω</span></small>
        </div>
        <div class="balance">
          –ú–æ–Ω–µ—Ç: <span id="coinsLabel">0</span>
        </div>
      </div>

      <div class="detail-tabs">
        <div class="detail-tab active" data-tab="farm" onclick="selectLocation('farm')">–ü–æ–ª—è</div>
        <div class="detail-tab" data-tab="seeds" onclick="selectLocation('seeds')">–°–µ–º–µ–Ω–∞</div>
        <div class="detail-tab" data-tab="tools" onclick="selectLocation('tools')">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
        <div class="detail-tab" data-tab="equipment" onclick="selectLocation('equipment')">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</div>
        <div class="detail-tab" data-tab="minigames" onclick="selectLocation('minigames')">–ú–∏–Ω–∏–∏–≥—Ä—ã</div>
      </div>

      <div class="detail-content" id="detailContent">
        <div class="farms-wrapper">
          <div class="single-farm">
            <div class="single-farm-header">
              <div class="single-farm-title">–ü–æ–ª–µ 1 (–æ—Å–Ω–æ–≤–Ω–æ–µ)</div>
              <div class="single-farm-tools" id="farm1ToolsLabel">
                –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: –Ω–µ—Ç ‚Ä¢ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: –Ω–µ—Ç
              </div>
            </div>
            <div id="farmGrid1" class="farm-grid"></div>
          </div>
          <div class="single-farm" id="farm2Container"></div>
          <p style="font-size:12px; color:#777; text-align:center;">
            –ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ –∫–ª–µ—Ç–∫–∏: –ø—É—Å—Ç–æ ‚Üí –≤—Å–ø–∞—Ö–∞–Ω–æ ‚Üí –ø–æ—Å–µ—è–Ω–æ ‚Üí (—Ä–∞—Å—Ç—ë—Ç) ‚Üí –≥–æ—Ç–æ–≤–æ ‚Üí –ø—É—Å—Ç–æ.
          </p>
        </div>
      </div>

      <button class="btn btn-back" onclick="showScreen('menuScreen')" style="margin-top:15px;">‚¨ÖÔ∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
    </div>
  </div>
</div>

<!-- ====== –ë–ê–ó–ê –ü–ï–†–°–û–ù–ê–ñ–ï–ô ====== -->
<div class="screen db hidden" id="dbScreen">
  <h1>–ë–∞–∑–∞ <span>–ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</span></h1>
  <p>–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤–∞—à–∏–º–∏ —Ñ–µ—Ä–º–µ—Ä–∞–º–∏</p>
  <p class="hint">–ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ –≤—ã–±–∏—Ä–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –∏–≥—Ä—ã</p>

  <div class="user-info">
    –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="dbCurrentUser">–ù–µ –≤–æ—à–ª–∏</span>
  </div>

  <form class="form" onsubmit="addCharacter(event)">
    <input type="text" id="charName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" required>
    <input type="text" id="charClass" placeholder="–ö–ª–∞—Å—Å" required>
    <input type="number" id="charLevel" placeholder="–£—Ä–æ–≤–µ–Ω—å" min="1" value="1" required>
    <button type="submit" class="btn btn-add">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
  </form>

  <table id="charactersTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>–ò–º—è</th>
        <th>–ö–ª–∞—Å—Å</th>
        <th>–£—Ä–æ–≤–µ–Ω—å</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="charactersBody"></tbody>
  </table>

  <button class="btn btn-back" onclick="showScreen('menuScreen')">‚¨ÖÔ∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
</div>

<!-- ====== –ú–û–î–ê–õ–ö–ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò / –õ–û–ì–ò–ù–ê ====== -->
<div class="modal" id="registerModal">
  <div class="modal-content">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</p>
    <form id="registerForm" onsubmit="registerUser(event)">
      <input type="text" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
      <input type="email" id="regEmail" placeholder="Email" required>
      <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
      <div class="error-message" id="registerError"></div>
      <div class="modal-btn-group">
        <button type="submit" class="btn btn-start">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <button type="button" class="btn btn-secondary" onclick="hideModal('registerModal')">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="loginModal">
  <div class="modal-content">
    <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
    <p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</p>
    <form id="loginForm" onsubmit="loginUser(event)">
      <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ Email" required>
      <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
      <div class="error-message" id="loginError"></div>
      <div class="modal-btn-group">
        <button type="submit" class="btn btn-start">–í–æ–π—Ç–∏</button>
        <button type="button" class="btn btn-secondary" onclick="hideModal('loginModal')">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <p style="text-align:center; margin-top:15px; font-size:14px;">
        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
        <a href="javascript:void(0)" onclick="switchToRegister()" style="color:#4b8b3b; text-decoration:underline;">
          –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
        </a>
      </p>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –º–∏–Ω–∏–∏–≥—Ä -->
<div class="modal" id="minigameModal">
  <div class="modal-content">
    <h2 id="minigameTitle">–ú–∏–Ω–∏–∏–≥—Ä—ã</h2>
    <p id="minigameSubtitle" style="font-size:13px;"></p>

    <div style="display:flex; gap:8px; margin-bottom:10px; justify-content:center; flex-wrap:wrap;">
      <button class="seed-buy-btn" style="padding:6px 10px; width:auto;" onclick="startFishingGame()">
        üé£ –†—ã–±–∞–ª–∫–∞
      </button>
      <button class="seed-buy-btn" style="padding:6px 10px; width:auto;" onclick="startCarrotGame()">
        üê∞ –ü–æ–π–º–∞–π –º–æ—Ä–∫–æ–≤–∫—É
      </button>
    </div>

    <div id="minigameArea" style="border-radius:12px; border:1px solid #e0f2e9; padding:10px; text-align:center; font-size:13px; color:#555; min-height:260px;">
      –í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–∏–≥—Ä—É –≤—ã—à–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.
    </div>

    <div class="modal-btn-group" style="margin-top:15px;">
      <button type="button" class="btn btn-start" onclick="closeMinigame()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
/* ===== –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ===== */
const images = {};
function loadGameImages(onReady) {
  const sources = {
    rabbit: 'img/rabbit.png',
    carrot: 'img/carrot.png',
    brick:  'img/brick.png',
    boat:   'img/boat.png',
    fishGood: 'img/fish_good.png',
    fishBad:  'img/fish_bad.png'
  };
  const keys = Object.keys(sources);
  if (!keys.length) { if (onReady) onReady(); return; }
  let loaded = 0;
  keys.forEach(key => {
    const img = new Image();
    img.src = sources[key];
    img.onload = img.onerror = () => {
      loaded++;
      if (loaded === keys.length && onReady) onReady();
    };
    images[key] = img;
  });
}

/* ===== –î–ê–ù–ù–´–ï –ò –°–û–°–¢–û–Ø–ù–ò–ï ===== */
let currentUser = null;
let users = JSON.parse(localStorage.getItem('farmquest_users')) || [];
let characters = JSON.parse(localStorage.getItem('farmquest_characters')) || [];
let farmTiles = JSON.parse(localStorage.getItem('farmquest_farms_v2')) || {};
let seedInventory = JSON.parse(localStorage.getItem('farmquest_seed_inventory')) || {};
let ownedUpgrades = JSON.parse(localStorage.getItem('farmquest_upgrades_v2')) || {};

let selectedRow = null;
let selectedCharacterId = null;
let activeLocation = 'farm';
let growthTimerId = null;

const SEED_TYPES = [
  { id: 'wheat', name: '–ü—à–µ–Ω–∏—Ü–∞', emoji: 'üåæ', price: 5,   packSize: 5,  sellReward: 3,  growTimeMs: 8000,  desc: '–†–∞—Å—Ç—ë—Ç –±—ã—Å—Ç—Ä–æ, –¥–∞—ë—Ç –º–∞–ª–æ –º–æ–Ω–µ—Ç.' },
  { id: 'corn',  name: '–ö—É–∫—É—Ä—É–∑–∞', emoji: 'üåΩ', price: 15,  packSize: 4,  sellReward: 7,  growTimeMs: 15000, desc: '–†–∞—Å—Ç—ë—Ç –¥–æ–ª—å—à–µ, –Ω–æ –ø—Ä–∏–±—ã–ª—å–Ω–µ–µ.' },
  { id: 'carrot',name: '–ú–æ—Ä–∫–æ–≤—å',  emoji: 'ü•ï', price: 10,  packSize: 6,  sellReward: 5,  growTimeMs: 12000, desc: '–°—Ä–µ–¥–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ –¥–æ—Ö–æ–¥—É.' }
];
const TOOLS = [
  { id: 'better_scythe', emoji:'üî™', name:'–û—Å—Ç—Ä–∞—è –∫–æ—Å–∞',   price:150, harvestBonus:2, desc:'+2 –º–æ–Ω–µ—Ç—ã –∑–∞ –∫–∞–∂–¥—ã–π —Å–±–æ—Ä.' },
  { id: 'golden_scythe', emoji:'‚öîÔ∏è', name:'–ó–æ–ª–æ—Ç–∞—è –∫–æ—Å–∞', price:400, harvestBonus:5, desc:'+5 –º–æ–Ω–µ—Ç –∑–∞ —Å–±–æ—Ä.' }
];
const EQUIP = [
  { id: 'small_tractor', emoji:'üöú', name:'–ú–∏–Ω–∏-—Ç—Ä–∞–∫—Ç–æ—Ä', price:300, harvestMultiplier:1.5, growSpeedMultiplier:0.8, desc:'+50% –º–æ–Ω–µ—Ç –∏ —Ä–æ—Å—Ç –Ω–∞ 20% –±—ã—Å—Ç—Ä–µ–µ.' },
  { id: 'harvester',     emoji:'üöö', name:'–ö–æ–º–±–∞–π–Ω',      price:700, harvestMultiplier:2,   growSpeedMultiplier:0.6, desc:'x2 –º–æ–Ω–µ—Ç—ã –∏ —Ä–æ—Å—Ç –Ω–∞ 40% –±—ã—Å—Ç—Ä–µ–µ.' }
];
const FIELD_UPGRADES = [
  { id:'second_field', emoji:'üß©', name:'–í—Ç–æ—Ä–æ–µ –ø–æ–ª–µ', price:500, desc:'–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ 3√ó3.' }
];

/* ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===== */
window.onload = function() {
  loadGameImages(() => {
    const savedUser = localStorage.getItem('farmquest_currentUser');
    if (savedUser) {
      currentUser = JSON.parse(savedUser);
      updateUserUI();
    }
    loadCharacters();
    updateCurrentCharLabel();
    updateCoinsLabel();
    startGrowthTimer();
  });
};

/* ===== –≠–ö–†–ê–ù–´/–ú–û–î–ê–õ–ö–ò ===== */
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
  document.getElementById(screenId).classList.remove('hidden');

  if (screenId === 'dbScreen') {
    document.getElementById('dbCurrentUser').textContent =
      currentUser ? currentUser.username : '–ù–µ –≤–æ—à–ª–∏';
  }
  if (screenId === 'gameScreen') {
    applyLocationUI();
    renderFarms();
  }
}
function showRegisterModal() {
  document.getElementById('registerModal').classList.add('show');
  document.getElementById('registerError').textContent = '';
}
function showLoginModal() {
  document.getElementById('loginModal').classList.add('show');
  document.getElementById('loginError').textContent = '';
}
function hideModal(id) {
  document.getElementById(id).classList.remove('show');
}
function switchToRegister() {
  hideModal('loginModal');
  showRegisterModal();
}

/* –ì–û–°–¢–¨ */
function loginAsGuest() {
  currentUser = { id:'guest', username:'–ì–æ—Å—Ç—å', email:null, isGuest:true };
  localStorage.setItem('farmquest_currentUser', JSON.stringify(currentUser));
  updateUserUI();
  loadCharacters();
  updateCoinsLabel();
}

/* –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø / –õ–û–ì–ò–ù */
function registerUser(e) {
  e.preventDefault();
  const username = regUsername.value.trim();
  const email = regEmail.value.trim();
  const password = regPassword.value;
  const userExists = users.some(u => u.username === username || u.email === email);
  if (userExists) {
    registerError.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –∏–ª–∏ email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
    return;
  }
  const newUser = { id:Date.now(), username, email, password, createdAt:new Date().toISOString() };
  users.push(newUser);
  localStorage.setItem('farmquest_users', JSON.stringify(users));
  login(username, password);
  registerForm.reset();
  hideModal('registerModal');
}
function loginUser(e) {
  e.preventDefault();
  const loginInput = loginUsername.value.trim();
  const password = loginPassword.value;
  login(loginInput, password);
}
function login(loginInput, password) {
  const user = users.find(u =>
    (u.username === loginInput || u.email === loginInput) && u.password === password
  );
  if (!user) {
    loginError.textContent = '–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
    return;
  }
  currentUser = { id:user.id, username:user.username, email:user.email, isGuest:false };
  localStorage.setItem('farmquest_currentUser', JSON.stringify(currentUser));
  updateUserUI();
  loginForm.reset();
  hideModal('loginModal');
  loadCharacters();
  updateCoinsLabel();
}

/* UI –∞–∫–∫–∞—É–Ω—Ç–∞ */
function updateUserUI() {
  if (currentUser) {
    currentUserLabel.textContent = currentUser.username;
    logoutBtn.style.display = 'inline-block';
  } else {
    currentUserLabel.textContent = '–ù–µ –≤–æ—à–ª–∏';
    logoutBtn.style.display = 'none';
  }
}
function logout() {
  currentUser = null;
  selectedCharacterId = null;
  localStorage.removeItem('farmquest_currentUser');
  updateUserUI();
  loadCharacters();
  updateCurrentCharLabel();
  updateCoinsLabel();
  renderFarms();
}

/* –ü–ï–†–°–û–ù–ê–ñ–ò */
function addCharacter(e) {
  e.preventDefault();
  if (!currentUser) {
    alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å!');
    return;
  }
  const name = charName.value.trim();
  const charClass = charClassInput.value.trim();
  const level = parseInt(charLevel.value);
  const newCharacter = {
    id:Date.now(),
    userId:currentUser.id,
    name,
    class:charClass,
    level,
    coins:20,
    createdAt:new Date().toISOString()
  };
  characters.push(newCharacter);
  saveCharacters();
  if (!selectedCharacterId) selectedCharacterId = newCharacter.id;
  loadCharacters();
  charName.value = '';
  charClassInput.value = '';
  charLevel.value = '1';
  updateCurrentCharLabel();
  updateCoinsLabel();
}
function loadCharacters() {
  const tbody = charactersBody;
  tbody.innerHTML = '';
  if (!currentUser) return;
  const userChars = characters.filter(c => c.userId === currentUser.id);
  userChars.forEach(ch => {
    const row = document.createElement('tr');
    row.onclick = () => selectRow(row, ch.id);
    if (ch.id === selectedCharacterId) {
      row.classList.add('selected-row');
      selectedRow = row;
    }
    row.innerHTML = `
      <td>${ch.id}</td>
      <td>${ch.name}</td>
      <td>${ch.class}</td>
      <td>${ch.level}</td>
      <td><button class="btn-delete" onclick="deleteCharacter(${ch.id}, event)">–£–¥–∞–ª–∏—Ç—å</button></td>
    `;
    tbody.appendChild(row);
  });
}
function selectRow(row, id) {
  if (selectedRow) selectedRow.classList.remove('selected-row');
  row.classList.add('selected-row');
  selectedRow = row;
  selectedCharacterId = id;
  const ch = characters.find(c => c.id === id);
  if (ch) {
    charName.value = ch.name;
    charClassInput.value = ch.class;
    charLevel.value = ch.level;
  }
  updateCurrentCharLabel();
  updateCoinsLabel();
  renderFarms();
}
function deleteCharacter(id, e) {
  e.stopPropagation();
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞?')) return;
  characters = characters.filter(c => c.id !== id);
  saveCharacters();

  if (currentUser && farmTiles[currentUser.id]) {
    delete farmTiles[currentUser.id][id];
    localStorage.setItem('farmquest_farms_v2', JSON.stringify(farmTiles));
  }
  if (currentUser && seedInventory[currentUser.id]) {
    delete seedInventory[currentUser.id][id];
    localStorage.setItem('farmquest_seed_inventory', JSON.stringify(seedInventory));
  }
  if (currentUser && ownedUpgrades[currentUser.id]) {
    delete ownedUpgrades[currentUser.id][id];
    localStorage.setItem('farmquest_upgrades_v2', JSON.stringify(ownedUpgrades));
  }

  if (selectedCharacterId === id) selectedCharacterId = null;
  loadCharacters();
  charName.value = '';
  charClassInput.value = '';
  charLevel.value = '1';
  if (selectedRow) { selectedRow.classList.remove('selected-row'); selectedRow = null; }
  updateCurrentCharLabel();
  updateCoinsLabel();
  renderFarms();
}

/* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ –ø–µ—Ä—Å–æ–Ω–∞–∂—É */
function getSelectedCharacter() {
  if (!currentUser || !selectedCharacterId) return null;
  return characters.find(c => c.id === selectedCharacterId && c.userId === currentUser.id) || null;
}
function saveCharacters() {
  localStorage.setItem('farmquest_characters', JSON.stringify(characters));
}
function updateCurrentCharLabel() {
  currentCharLabel.textContent = getSelectedCharacter()?.name || '–Ω–µ –≤—ã–±—Ä–∞–Ω';
}
function updateCoinsLabel() {
  const ch = getSelectedCharacter();
  coinsLabel.textContent = ch ? (ch.coins || 0) : 0;
}

/* –§–ï–†–ú–´ –ò –£–õ–£–ß–®–ï–ù–ò–Ø */
function getFarmKey(farmIndex) {
  if (!currentUser || !selectedCharacterId) return null;
  return { userId:String(currentUser.id), charId:String(selectedCharacterId), farmIndex };
}
function ensureFarm(farmIndex) {
  const key = getFarmKey(farmIndex);
  if (!key) return null;
  if (!farmTiles[key.userId]) farmTiles[key.userId] = {};
  if (!farmTiles[key.userId][key.charId]) farmTiles[key.userId][key.charId] = {};
  if (!farmTiles[key.userId][key.charId][farmIndex]) {
    const tiles = [];
    for (let i=0;i<9;i++) tiles.push({ state:'empty', plantedAt:null, seedId:null, growTimeMs:0 });
    farmTiles[key.userId][key.charId][farmIndex] = tiles;
    localStorage.setItem('farmquest_farms_v2', JSON.stringify(farmTiles));
  }
  return farmTiles[key.userId][key.charId][farmIndex];
}
function getUpgradeState() {
  if (!currentUser || !selectedCharacterId) return null;
  const u = String(currentUser.id);
  const c = String(selectedCharacterId);
  if (!ownedUpgrades[u]) ownedUpgrades[u] = {};
  if (!ownedUpgrades[u][c]) ownedUpgrades[u][c] = { tools:{}, equip:{}, hasSecondField:false };
  return ownedUpgrades[u][c];
}

function renderFarms() {
  if (activeLocation !== 'farm') return;
  const farmGrid1 = document.getElementById('farmGrid1');
  const farm2Container = document.getElementById('farm2Container');
  if (!farmGrid1 || !farm2Container) return;

  farmGrid1.innerHTML = '';
  farm2Container.innerHTML = '';

  const tiles1 = ensureFarm(1);
  const now = Date.now();
  const growSpeed = getGrowSpeedMultiplier();

  tiles1.forEach(t => {
    if (t.state === 'planted' && t.plantedAt && t.growTimeMs) {
      if (now - t.plantedAt >= t.growTimeMs * growSpeed) t.state = 'ready';
    }
  });
  tiles1.forEach((t, idx) => {
    const d = document.createElement('div');
    d.classList.add('tile', t.state);
    let emoji = '';
    if (t.state === 'tilled') emoji = 'ü™ì';
    if (t.state === 'planted' || t.state === 'ready') {
      const seed = SEED_TYPES.find(s => s.id === t.seedId);
      emoji = seed ? seed.emoji : 'üå±';
      if (t.state === 'ready') emoji = '‚úÖ';
    }
    d.textContent = emoji;
    d.addEventListener('click', () => onTileClick(1, idx));
    farmGrid1.appendChild(d);
  });

  const upg = getUpgradeState();
  const hasSecond = upg && upg.hasSecondField;
  if (!hasSecond) {
    farm2Container.innerHTML = `
      <div class="locked-farm">
        –í—Ç–æ—Ä–æ–µ –ø–æ–ª–µ –∑–∞–∫—Ä—ã—Ç–æ. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ –≤ –º–∞–≥–∞–∑–∏–Ω–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è.
        <br>
        <button onclick="buySecondField()">–û—Ç–∫—Ä—ã—Ç—å –∑–∞ ${FIELD_UPGRADES[0].price} –º–æ–Ω–µ—Ç</button>
      </div>
    `;
  } else {
    farm2Container.innerHTML = `
      <div class="single-farm-header">
        <div class="single-farm-title">–ü–æ–ª–µ 2 (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ)</div>
        <div class="single-farm-tools" id="farm2ToolsLabel">
          –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: –æ–±—â–∏–µ ‚Ä¢ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: –æ–±—â–∏–µ
        </div>
      </div>
      <div id="farmGrid2" class="farm-grid"></div>
    `;
    const farmGrid2 = document.getElementById('farmGrid2');
    const tiles2 = ensureFarm(2);
    tiles2.forEach(t => {
      if (t.state === 'planted' && t.plantedAt && t.growTimeMs) {
        if (now - t.plantedAt >= t.growTimeMs * growSpeed) t.state = 'ready';
      }
    });
    tiles2.forEach((t, idx) => {
      const d = document.createElement('div');
      d.classList.add('tile', t.state);
      let emoji = '';
      if (t.state === 'tilled') emoji = 'ü™ì';
      if (t.state === 'planted' || t.state === 'ready') {
        const seed = SEED_TYPES.find(s => s.id === t.seedId);
        emoji = seed ? seed.emoji : 'üå±';
        if (t.state === 'ready') emoji = '‚úÖ';
      }
      d.textContent = emoji;
      d.addEventListener('click', () => onTileClick(2, idx));
      farmGrid2.appendChild(d);
    });
  }

  updateFarmToolsLabels();
  localStorage.setItem('farmquest_farms_v2', JSON.stringify(farmTiles));
}

function onTileClick(farmIndex, tileIndex) {
  const key = getFarmKey(farmIndex);
  if (!key) {
    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ –±–∞–∑–µ.');
    return;
  }
  const tiles = ensureFarm(farmIndex);
  const tile = tiles[tileIndex];
  const ch = getSelectedCharacter();
  if (!ch) return;

  if (tile.state === 'empty') {
    tile.state = 'tilled';
    tile.seedId = null;
  } else if (tile.state === 'tilled') {
    const seedId = getAnySeedWithQuantity();
    if (!seedId) { alert('–ù–µ—Ç —Å–µ–º—è–Ω. –ö—É–ø–∏—Ç–µ –∏—Ö –≤ –º–∞–≥–∞–∑–∏–Ω–µ.'); return; }
    if (!consumeSeed(seedId)) { alert('–ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å —Å–µ–º–µ–Ω–∞.'); return; }
    const seed = SEED_TYPES.find(s => s.id === seedId);
    tile.state = 'planted';
    tile.seedId = seedId;
    tile.plantedAt = Date.now();
    tile.growTimeMs = seed ? seed.growTimeMs : 10000;
  } else if (tile.state === 'planted') {
    return;
  } else if (tile.state === 'ready') {
    const seed = SEED_TYPES.find(s => s.id === tile.seedId);
    const baseReward = seed ? seed.sellReward : 2;
    const bonus = getHarvestBonus();
    const mult = getHarvestMultiplier();
    const total = Math.round((baseReward + bonus) * mult);
    ch.coins = (ch.coins || 0) + total;
    saveCharacters();
    updateCoinsLabel();
    tile.state = 'empty';
    tile.plantedAt = null;
    tile.seedId = null;
    tile.growTimeMs = 0;
  }

  localStorage.setItem('farmquest_farms_v2', JSON.stringify(farmTiles));
  renderFarms();
}

function startGrowthTimer() {
  if (growthTimerId) clearInterval(growthTimerId);
  growthTimerId = setInterval(() => {
    if (!currentUser || !selectedCharacterId) return;
    if (activeLocation !== 'farm') return;
    renderFarms();
  }, 2000);
}

/* –°–ï–ú–ï–ù–ê (–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å) */
function getSeedInvKey() {
  if (!currentUser || !selectedCharacterId) return null;
  return { userId:String(currentUser.id), charId:String(selectedCharacterId) };
}
function ensureSeedInv() {
  const k = getSeedInvKey();
  if (!k) return null;
  if (!seedInventory[k.userId]) seedInventory[k.userId] = {};
  if (!seedInventory[k.userId][k.charId]) seedInventory[k.userId][k.charId] = {};
  return seedInventory[k.userId][k.charId];
}
function getSeedCount(seedId) {
  const inv = ensureSeedInv();
  if (!inv) return 0;
  return inv[seedId] || 0;
}
function addSeeds(seedId, qty) {
  const inv = ensureSeedInv();
  if (!inv) return;
  inv[seedId] = (inv[seedId] || 0) + qty;
  localStorage.setItem('farmquest_seed_inventory', JSON.stringify(seedInventory));
}
function consumeSeed(seedId) {
  const inv = ensureSeedInv();
  if (!inv || !inv[seedId] || inv[seedId] <= 0) return false;
  inv[seedId] -= 1;
  localStorage.setItem('farmquest_seed_inventory', JSON.stringify(seedInventory));
  if (activeLocation === 'seeds') renderSeedsShop();
  return true;
}
function getAnySeedWithQuantity() {
  const inv = ensureSeedInv();
  if (!inv) return null;
  const ids = Object.keys(inv).filter(id => inv[id] > 0);
  return ids[0] || null;
}
function buySeed(seedId) {
  const ch = getSelectedCharacter();
  if (!ch) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.'); return; }
  const seed = SEED_TYPES.find(s => s.id === seedId);
  if (!seed) return;
  if ((ch.coins || 0) < seed.price) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –ø–∞–∫–µ—Ç–∞ "'+seed.name+'".');
    return;
  }
  ch.coins -= seed.price;
  saveCharacters();
  updateCoinsLabel();
  addSeeds(seedId, seed.packSize);
  if (activeLocation === 'seeds') renderSeedsShop();
}

/* –£–õ–£–ß–®–ï–ù–ò–Ø */
function getHarvestBonus() {
  const u = getUpgradeState();
  if (!u) return 0;
  let b = 0;
  TOOLS.forEach(t => { if (u.tools[t.id]) b += t.harvestBonus; });
  return b;
}
function getHarvestMultiplier() {
  const u = getUpgradeState();
  if (!u) return 1;
  let m = 1;
  EQUIP.forEach(e => { if (u.equip[e.id]) m *= e.harvestMultiplier; });
  return m;
}
function getGrowSpeedMultiplier() {
  const u = getUpgradeState();
  if (!u) return 1;
  let m = 1;
  EQUIP.forEach(e => { if (u.equip[e.id]) m *= e.growSpeedMultiplier; });
  return m;
}
function buyTool(id) {
  const ch = getSelectedCharacter();
  if (!ch) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.'); return; }
  const tool = TOOLS.find(t => t.id === id);
  if (!tool) return;
  const u = getUpgradeState();
  if (u.tools[id]) return;
  if ((ch.coins || 0) < tool.price) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏ "'+tool.name+'".');
    return;
  }
  ch.coins -= tool.price;
  saveCharacters();
  updateCoinsLabel();
  u.tools[id] = true;
  localStorage.setItem('farmquest_upgrades_v2', JSON.stringify(ownedUpgrades));
  if (activeLocation === 'tools') renderToolsShop();
  updateFarmToolsLabels();
}
function buyEquip(id) {
  const ch = getSelectedCharacter();
  if (!ch) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.'); return; }
  const eq = EQUIP.find(e => e.id === id);
  if (!eq) return;
  const u = getUpgradeState();
  if (u.equip[id]) return;
  if ((ch.coins || 0) < eq.price) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏ "'+eq.name+'".');
    return;
  }
  ch.coins -= eq.price;
  saveCharacters();
  updateCoinsLabel();
  u.equip[id] = true;
  localStorage.setItem('farmquest_upgrades_v2', JSON.stringify(ownedUpgrades));
  if (activeLocation === 'equipment') renderEquipmentShop();
  updateFarmToolsLabels();
}
function buySecondField() {
  const ch = getSelectedCharacter();
  if (!ch) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.'); return; }
  const u = getUpgradeState();
  if (u.hasSecondField) return;
  const cost = FIELD_UPGRADES[0].price;
  if ((ch.coins || 0) < cost) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ª—è.');
    return;
  }
  ch.coins -= cost;
  saveCharacters();
  updateCoinsLabel();
  u.hasSecondField = true;
  localStorage.setItem('farmquest_upgrades_v2', JSON.stringify(ownedUpgrades));
  renderFarms();
}
function updateFarmToolsLabels() {
  const u = getUpgradeState();
  const f1 = document.getElementById('farm1ToolsLabel');
  const f2 = document.getElementById('farm2ToolsLabel');
  let toolsText = '–Ω–µ—Ç';
  let equipText = '–Ω–µ—Ç';
  if (u) {
    const activeTools = TOOLS.filter(t => u.tools[t.id]).map(t => t.emoji).join(' ');
    const activeEquip = EQUIP.filter(e => u.equip[e.id]).map(e => e.emoji).join(' ');
    if (activeTools) toolsText = activeTools;
    if (activeEquip) equipText = activeEquip;
  }
  if (f1) f1.textContent = `–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: ${toolsText} ‚Ä¢ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: ${equipText}`;
  if (f2) f2.textContent = `–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: –æ–±—â–∏–µ ‚Ä¢ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: –æ–±—â–∏–µ`;
}

/* –õ–û–ö–ê–¶–ò–ò */
function selectLocation(loc) {
  activeLocation = loc;
  document.querySelectorAll('.map-tile').forEach(t => {
    if (t.dataset.location === loc) t.classList.add('active');
    else t.classList.remove('active');
  });
  document.querySelectorAll('.detail-tab').forEach(t => {
    if (t.dataset.tab === loc) t.classList.add('active');
    else t.classList.remove('active');
  });
  applyLocationUI();
}
function applyLocationUI() {
  const title = detailTitle;
  const content = detailContent;

  if (activeLocation === 'farm') {
    title.textContent = '–ü–æ–ª—è';
    content.innerHTML = `
      <div class="farms-wrapper">
        <div class="single-farm">
          <div class="single-farm-header">
            <div class="single-farm-title">–ü–æ–ª–µ 1 (–æ—Å–Ω–æ–≤–Ω–æ–µ)</div>
            <div class="single-farm-tools" id="farm1ToolsLabel">
              –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: –Ω–µ—Ç ‚Ä¢ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: –Ω–µ—Ç
            </div>
          </div>
          <div id="farmGrid1" class="farm-grid"></div>
        </div>
        <div class="single-farm" id="farm2Container"></div>
        <p style="font-size:12px; color:#777; text-align:center;">
          –ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ –∫–ª–µ—Ç–∫–∏: –ø—É—Å—Ç–æ ‚Üí –≤—Å–ø–∞—Ö–∞–Ω–æ ‚Üí –ø–æ—Å–µ—è–Ω–æ ‚Üí (—Ä–∞—Å—Ç—ë—Ç) ‚Üí –≥–æ—Ç–æ–≤–æ ‚Üí –ø—É—Å—Ç–æ.
        </p>
      </div>
    `;
    renderFarms();
  } else if (activeLocation === 'seeds') {
    title.textContent = '–ú–∞–≥–∞–∑–∏–Ω —Å–µ–º—è–Ω';
    content.innerHTML = `
      <div>
        <p style="font-size:13px; color:#777; margin-bottom:6px;">
          –ü–æ–∫—É–ø–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ —Å–µ–º—è–Ω. –ó–∞ –∫–∞–∂–¥—É—é –ø–æ–∫—É–ø–∫—É –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫.
        </p>
        <div class="seeds-shop" id="seedsShop"></div>
      </div>
    `;
    renderSeedsShop();
  } else if (activeLocation === 'tools') {
    title.textContent = '–ú–∞–≥–∞–∑–∏–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤';
    content.innerHTML = `
      <div>
        <p style="font-size:13px; color:#777; margin-bottom:6px;">
          –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –º–æ–Ω–µ—Ç—ã –∑–∞ –∫–∞–∂–¥—ã–π —Å–±–æ—Ä —É—Ä–æ–∂–∞—è.
        </p>
        <div class="shop-list" id="toolsShop"></div>
      </div>
    `;
    renderToolsShop();
  } else if (activeLocation === 'equipment') {
    title.textContent = '–ú–∞–≥–∞–∑–∏–Ω –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è';
    content.innerHTML = `
      <div>
        <p style="font-size:13px; color:#777; margin-bottom:6px;">
          –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —É–º–Ω–æ–∂–∞–µ—Ç –Ω–∞–≥—Ä–∞–¥—É, —É—Å–∫–æ—Ä—è–µ—Ç —Ä–æ—Å—Ç –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–µ –ø–æ–ª–µ.
        </p>
        <div class="shop-list" id="equipmentShop"></div>
      </div>
    `;
    renderEquipmentShop();
  } else if (activeLocation === 'minigames') {
    title.textContent = '–ú–∏–Ω–∏–∏–≥—Ä—ã';
    content.innerHTML = `
      <div class="minigames-placeholder">
        –ó–¥–µ—Å—å –¥–æ—Å—Ç—É–ø–Ω—ã –º–∏–Ω–∏–∏–≥—Ä—ã, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–Ω–µ—Ç—ã.
        <div class="minigame-card">
          üé£ –†—ã–±–∞–ª–∫–∞ –∏ üê∞ –ü–æ–π–º–∞–π –º–æ—Ä–∫–æ–≤–∫—É.<br>
          <button class="seed-buy-btn" style="margin-top:6px; padding:6px 14px;" onclick="openMinigame()">
            –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –º–∏–Ω–∏–∏–≥—Ä
          </button>
        </div>
      </div>
    `;
  }
}
function renderSeedsShop() {
  const cont = document.getElementById('seedsShop');
  if (!cont) return;
  cont.innerHTML = '';
  const ch = getSelectedCharacter();
  SEED_TYPES.forEach(seed => {
    const count = ch ? getSeedCount(seed.id) : 0;
    const item = document.createElement('div');
    item.className = 'seed-item';
    item.innerHTML = `
      <div class="seed-header">
        <span class="emoji">${seed.emoji}</span>
        <div class="seed-name">${seed.name}</div>
      </div>
      <div class="seed-desc">${seed.desc}</div>
      <div class="seed-footer">
        <div>
          <div class="seed-price">${seed.price} –º–æ–Ω–µ—Ç / ${seed.packSize} —à—Ç.</div>
          <div class="seed-owned ${count>0?'':'none'}">
            –ù–∞ —Å–∫–ª–∞–¥–µ: ${count} —à—Ç.
          </div>
        </div>
        <button class="seed-buy-btn">–ö—É–ø–∏—Ç—å</button>
      </div>
    `;
    item.querySelector('.seed-buy-btn').addEventListener('click', () => buySeed(seed.id));
    cont.appendChild(item);
  });
}
function renderToolsShop() {
  const cont = document.getElementById('toolsShop');
  if (!cont) return;
  cont.innerHTML = '';
  TOOLS.forEach(tool => {
    const u = getUpgradeState();
    const owned = u && u.tools[tool.id];
    const item = document.createElement('div');
    item.className = 'shop-item';
    item.innerHTML = `
      <div class="shop-header"><span class="emoji">${tool.emoji}</span><div class="shop-name">${tool.name}</div></div>
      <div class="shop-desc">${tool.desc}</div>
      <div class="shop-footer">
        <div>
          <div class="shop-price">${tool.price} –º–æ–Ω–µ—Ç</div>
          <div class="shop-owned ${owned?'':'none'}">${owned?'–ö—É–ø–ª–µ–Ω–æ':'–ù–µ –∫—É–ø–ª–µ–Ω–æ'}</div>
        </div>
        <button class="shop-buy-btn" ${owned?'disabled':''}>–ö—É–ø–∏—Ç—å</button>
      </div>
    `;
    item.querySelector('.shop-buy-btn').addEventListener('click', () => buyTool(tool.id));
    cont.appendChild(item);
  });
}
function renderEquipmentShop() {
  const cont = document.getElementById('equipmentShop');
  if (!cont) return;
  cont.innerHTML = '';
  const u = getUpgradeState();
  EQUIP.forEach(eq => {
    const owned = u && u.equip[eq.id];
    const item = document.createElement('div');
    item.className = 'shop-item';
    item.innerHTML = `
      <div class="shop-header"><span class="emoji">${eq.emoji}</span><div class="shop-name">${eq.name}</div></div>
      <div class="shop-desc">${eq.desc}</div>
      <div class="shop-footer">
        <div>
          <div class="shop-price">${eq.price} –º–æ–Ω–µ—Ç</div>
          <div class="shop-owned ${owned?'':'none'}">${owned?'–ö—É–ø–ª–µ–Ω–æ':'–ù–µ –∫—É–ø–ª–µ–Ω–æ'}</div>
        </div>
        <button class="shop-buy-btn" ${owned?'disabled':''}>–ö—É–ø–∏—Ç—å</button>
      </div>
    `;
    item.querySelector('.shop-buy-btn').addEventListener('click', () => buyEquip(eq.id));
    cont.appendChild(item);
  });
  const hasSecond = u && u.hasSecondField;
  const fieldItem = document.createElement('div');
  fieldItem.className = 'shop-item';
  fieldItem.innerHTML = `
    <div class="shop-header"><span class="emoji">üß©</span><div class="shop-name">–í—Ç–æ—Ä–æ–µ –ø–æ–ª–µ</div></div>
    <div class="shop-desc">${FIELD_UPGRADES[0].desc}</div>
    <div class="shop-footer">
      <div>
        <div class="shop-price">${FIELD_UPGRADES[0].price} –º–æ–Ω–µ—Ç</div>
        <div class="shop-owned ${hasSecond?'':'none'}">${hasSecond?'–û—Ç–∫—Ä—ã—Ç–æ':'–ó–∞–∫—Ä—ã—Ç–æ'}</div>
      </div>
      <button class="shop-buy-btn" ${hasSecond?'disabled':''}>–ö—É–ø–∏—Ç—å</button>
    </div>
  `;
  fieldItem.querySelector('.shop-buy-btn').addEventListener('click', buySecondField);
  cont.appendChild(fieldItem);
}

/* –ú–ò–ù–ò–ò–ì–†–´ ‚Äì –û–ë–©–ï–ï –û–ö–ù–û */
function openMinigame() {
  document.getElementById('minigameModal').classList.add('show');
  minigameTitle.textContent = '–ú–∏–Ω–∏–∏–≥—Ä—ã';
  minigameSubtitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É: –†—ã–±–∞–ª–∫–∞ –∏–ª–∏ –ü–æ–π–º–∞–π –º–æ—Ä–∫–æ–≤–∫—É.';
  minigameArea.innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–∏–≥—Ä—É –≤—ã—à–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.';
}
function closeMinigame() {
  document.getElementById('minigameModal').classList.remove('show');
  stopFishingGame();
  stopCarrotGame();
}

/* ====== –ú–ò–ù–ò–ò–ì–†–ê: –†–´–ë–ê–õ–ö–ê ===== */

let fishingRunning = false;
let fishObjects = [];
let fishingScore = 0;
let fishingTimeLeft = 25;
let fishingLoopId = null;
let fishingTimeId = null;

const fishingConfig = {
  width: 500,
  height: 260,
  boatWidth: 70,
  boatHeight: 20,
  boatSpeed: 4,
  hookSpeed: 4,
  lineMaxDepth: 160,
  fishCount: 7
};

const fishingState = {
  boatX: 0,
  boatY: 0,
  hookY: 0,
  keys: { left:false, right:false, up:false, down:false }
};

function startFishingGame() {
  stopCarrotGame();
  stopFishingGame();
  fishingRunning = true;
  fishingScore = 0;
  fishingTimeLeft = 25;
  fishObjects = [];

  minigameTitle.textContent = '–†—ã–±–∞–ª–∫–∞';
  minigameSubtitle.textContent =
    '–õ–æ–¥–∫–∞ –∏ –ª–µ—Å–∫–∞: –ª–æ–≤–∏—Ç–µ —Ä—ã–±—É üêü, –∏–∑–±–µ–≥–∞–π—Ç–µ –º—É—Å–æ—Ä–∞ ü©¥/üóë. –°—Ç—Ä–µ–ª–∫–∏ –∏–ª–∏ –∫–Ω–æ–ø–∫–∏.';

  minigameArea.innerHTML = `
    <canvas id="fishingCanvas" width="${fishingConfig.width}" height="${fishingConfig.height}" class="minigame-canvas"></canvas>
    <div class="fish-controls">
      <button onclick="fishMoveButton('left')">‚¨ÖÔ∏è –í–ª–µ–≤–æ</button>
      <button onclick="fishMoveButton('right')">‚û°Ô∏è –í–ø—Ä–∞–≤–æ</button>
      <button onclick="fishMoveButton('up')">‚¨ÜÔ∏è –ü–æ–¥–Ω—è—Ç—å –ª–µ—Å–∫—É</button>
      <button onclick="fishMoveButton('down')">‚¨áÔ∏è –û–ø—É—Å—Ç–∏—Ç—å –ª–µ—Å–∫—É</button>
    </div>
    <div class="minigame-info" id="fishingInfo">
      –û—á–∫–∏: 0 ‚Ä¢ –í—Ä–µ–º—è: 25 c
    </div>
  `;

  const canvas = document.getElementById('fishingCanvas');
  const ctx = canvas.getContext('2d');

  fishingState.boatX = fishingConfig.width / 2 - fishingConfig.boatWidth / 2;
  fishingState.boatY = 20;
  fishingState.hookY = fishingState.boatY + fishingConfig.boatHeight;

  for (let i = 0; i < fishingConfig.fishCount; i++) {
    fishObjects.push(spawnFishObject());
  }

  window.addEventListener('keydown', fishingKeyDown);
  window.addEventListener('keyup', fishingKeyUp);

  fishingLoopId = setInterval(() => {
    updateFishing();
    drawFishing(ctx);
  }, 33);

  fishingTimeId = setInterval(() => {
    if (!fishingRunning) return;
    fishingTimeLeft--;
    updateFishingInfo();
    if (fishingTimeLeft <= 0) {
      finishFishingGame();
    }
  }, 1000);
}

function spawnFishObject() {
  const types = [
    { emoji:'üêü', score:3,  speed:1.3 },
    { emoji:'üê†', score:5,  speed:1.7 },
    { emoji:'üê°', score:8,  speed:2.1 },
    { emoji:'ü©¥', score:-5, speed:1.4 },
    { emoji:'üóë', score:-3, speed:1.0 }
  ];
  const t = types[Math.floor(Math.random() * types.length)];
  const side = Math.random() < 0.5 ? 'left' : 'right';
  const y = 70 + Math.random() * (fishingConfig.height - 70);
  const x = side === 'left' ? -40 : fishingConfig.width + 40;
  const vx = side === 'left' ? t.speed : -t.speed;
  return { x, y, vx, emoji:t.emoji, score:t.score, w:32, h:24 };
}

function fishingKeyDown(e) {
  if (!fishingRunning) return;
  if (e.key === 'ArrowLeft')  fishingState.keys.left  = true;
  if (e.key === 'ArrowRight') fishingState.keys.right = true;
  if (e.key === 'ArrowUp')    fishingState.keys.up    = true;
  if (e.key === 'ArrowDown')  fishingState.keys.down  = true;
}
function fishingKeyUp(e) {
  if (!fishingRunning) return;
  if (e.key === 'ArrowLeft')  fishingState.keys.left  = false;
  if (e.key === 'ArrowRight') fishingState.keys.right = false;
  if (e.key === 'ArrowUp')    fishingState.keys.up    = false;
  if (e.key === 'ArrowDown')  fishingState.keys.down  = false;
}

function fishMoveButton(dir) {
  if (!fishingRunning) return;
  if (dir === 'left')  fishingState.boatX -= fishingConfig.boatSpeed * 2;
  if (dir === 'right') fishingState.boatX += fishingConfig.boatSpeed * 2;
  if (dir === 'down')  fishingState.hookY += fishingConfig.hookSpeed * 2;
  if (dir === 'up')    fishingState.hookY -= fishingConfig.hookSpeed * 2;
  clampFishingPositions();
}

function clampFishingPositions() {
  if (fishingState.boatX < 0) fishingState.boatX = 0;
  if (fishingState.boatX + fishingConfig.boatWidth > fishingConfig.width)
    fishingState.boatX = fishingConfig.width - fishingConfig.boatWidth;

  const minHookY = fishingState.boatY + fishingConfig.boatHeight;
  const maxHookY = minHookY + fishingConfig.lineMaxDepth;
  if (fishingState.hookY < minHookY) fishingState.hookY = minHookY;
  if (fishingState.hookY > maxHookY) fishingState.hookY = maxHookY;
}

function updateFishing() {
  if (!fishingRunning) return;
  if (fishingState.keys.left)  fishingState.boatX -= fishingConfig.boatSpeed;
  if (fishingState.keys.right) fishingState.boatX += fishingConfig.boatSpeed;
  if (fishingState.keys.up)    fishingState.hookY -= fishingConfig.hookSpeed;
  if (fishingState.keys.down)  fishingState.hookY += fishingConfig.hookSpeed;
  clampFishingPositions();

  fishObjects.forEach(f => { f.x += f.vx; });
  for (let i = 0; i < fishObjects.length; i++) {
    const f = fishObjects[i];
    if (f.x < -60 || f.x > fishingConfig.width + 60) {
      fishObjects[i] = spawnFishObject();
    }
  }

  const hookX = fishingState.boatX + fishingConfig.boatWidth / 2;
  const hookY = fishingState.hookY;
  const hookR = 8;

  for (let i = 0; i < fishObjects.length; i++) {
    const f = fishObjects[i];
    const closestX = Math.max(f.x - f.w/2, Math.min(hookX, f.x + f.w/2));
    const closestY = Math.max(f.y - f.h/2, Math.min(hookY, f.y + f.h/2));
    const dx = hookX - closestX;
    const dy = hookY - closestY;
    if (dx*dx + dy*dy < hookR*hookR) {
      fishingScore += f.score;
      if (f.score < 0 && fishingScore < 0) fishingScore = 0;
      fishObjects[i] = spawnFishObject();
    }
  }
  updateFishingInfo();
}

function drawFishing(ctx) {
  if (!fishingRunning) return;
  const w = fishingConfig.width;
  const h = fishingConfig.height;
  ctx.clearRect(0,0,w,h);

  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,'#4fc3f7');
  grad.addColorStop(1,'#01579b');
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,w,h);

  ctx.fillStyle = '#ffe082';
  ctx.fillRect(0,0,w,30);

  // –ø—Ä–æ—Å—Ç–∞—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∞—è –ª–æ–¥–∫–∞
  ctx.fillStyle = '#8d6e63';
  ctx.fillRect(
    fishingState.boatX,
    fishingState.boatY,
    fishingConfig.boatWidth,
    fishingConfig.boatHeight
  );

  const hookX = fishingState.boatX + fishingConfig.boatWidth / 2;
  const hookY = fishingState.hookY;
  ctx.strokeStyle = '#fafafa';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(hookX, fishingState.boatY + fishingConfig.boatHeight);
  ctx.lineTo(hookX, hookY);
  ctx.stroke();

  ctx.fillStyle = '#ffeb3b';
  ctx.beginPath();
  ctx.arc(hookX, hookY, 6, 0, Math.PI*2);
  ctx.fill();

  ctx.font = '22px system-ui';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  fishObjects.forEach(f => {
    ctx.fillText(f.emoji, f.x, f.y);
  });
}

function updateFishingInfo() {
  const info = document.getElementById('fishingInfo');
  if (info) info.textContent = `–û—á–∫–∏: ${fishingScore} ‚Ä¢ –í—Ä–µ–º—è: ${fishingTimeLeft} c`;
}
function stopFishingGame() {
  fishingRunning = false;
  if (fishingLoopId) { clearInterval(fishingLoopId); fishingLoopId = null; }
  if (fishingTimeId) { clearInterval(fishingTimeId); fishingTimeId = null; }
  window.removeEventListener('keydown', fishingKeyDown);
  window.removeEventListener('keyup', fishingKeyUp);
}
function finishFishingGame() {
  if (!fishingRunning) return;
  fishingRunning = false;
  stopFishingGame();
  const ch = getSelectedCharacter();
  if (!ch) return;
  const reward = Math.max(0, fishingScore);
  if (reward > 0) {
    ch.coins = (ch.coins || 0) + reward;
    saveCharacters();
    updateCoinsLabel();
  }
  const info = document.getElementById('fishingInfo');
  if (info) info.textContent += ` ‚Ä¢ –ù–∞–≥—Ä–∞–¥–∞: +${reward} –º–æ–Ω–µ—Ç`;
}

/* ====== –ú–ò–ù–ò–ò–ì–†–ê: –ü–û–ô–ú–ê–ô –ú–û–†–ö–û–í–ö–£ ===== */

let carrotGameRunning = false;
let carrotLoopId = null;
let carrotSpawnId = null;
let carrotScore2 = 0;
let carrotLives = 3;
const carrotObjects = [];
const carrotConfig = {
  width: 500,
  height: 260,
  rabbitWidth: 60,
  rabbitHeight: 50,
  rabbitSpeed: 5,
  gravity: 3,
  spawnInterval: 700
};
const carrotState = {
  rabbitX: 0,
  rabbitY: 0,
  keys:{left:false,right:false}
};

function startCarrotGame() {
  stopFishingGame();
  stopCarrotGame();
  carrotGameRunning = true;
  carrotScore2 = 0;
  carrotLives = 3;
  carrotObjects.length = 0;

  minigameTitle.textContent = '–ü–æ–π–º–∞–π –º–æ—Ä–∫–æ–≤–∫—É';
  minigameSubtitle.textContent = '–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∫—Ä–æ–ª–∏–∫–æ–º. –õ–æ–≤–∏—Ç–µ –º–æ—Ä–∫–æ–≤–∫–∏, –∏–∑–±–µ–≥–∞–π—Ç–µ –∫–∏—Ä–ø–∏—á–µ–π. –ò–≥—Ä–∞ –¥–æ –ø–æ—Ç–µ—Ä–∏ –≤—Å–µ—Ö –∂–∏–∑–Ω–µ–π.';

  minigameArea.innerHTML = `
    <canvas id="carrotCanvas" width="${carrotConfig.width}" height="${carrotConfig.height}" class="minigame-canvas"></canvas>
    <div class="carrot-controls">
      <button onclick="carrotMoveButton('left')">‚¨ÖÔ∏è –í–ª–µ–≤–æ</button>
      <button onclick="carrotMoveButton('right')">‚û°Ô∏è –í–ø—Ä–∞–≤–æ</button>
    </div>
    <div class="minigame-info" id="carrotInfo">
      –û—á–∫–∏: 0 ‚Ä¢ –ñ–∏–∑–Ω–∏: 3
    </div>
  `;

  const canvas = document.getElementById('carrotCanvas');
  const ctx = canvas.getContext('2d');

  carrotState.rabbitX = carrotConfig.width/2 - carrotConfig.rabbitWidth/2;
  carrotState.rabbitY = carrotConfig.height-60;

  window.addEventListener('keydown', carrotKeyDown);
  window.addEventListener('keyup', carrotKeyUp);

  carrotLoopId = setInterval(() => {
    updateCarrotGame();
    drawCarrotGame(ctx);
  }, 33);

  carrotSpawnId = setInterval(() => {
    if (!carrotGameRunning) return;
    spawnFallingObject();
  }, carrotConfig.spawnInterval);
}

function spawnFallingObject() {
  const isCarrot = Math.random() < 0.7;
  const obj = {
    x: 20 + Math.random()*(carrotConfig.width-40),
    y: -30,
    vy: carrotConfig.gravity + Math.random()*1.5,
    w: 26,
    h: 36,
    type: isCarrot ? 'carrot' : 'brick'
  };
  carrotObjects.push(obj);
}

function carrotKeyDown(e) {
  if (!carrotGameRunning) return;
  if (e.key === 'ArrowLeft') carrotState.keys.left = true;
  if (e.key === 'ArrowRight') carrotState.keys.right = true;
}
function carrotKeyUp(e) {
  if (!carrotGameRunning) return;
  if (e.key === 'ArrowLeft') carrotState.keys.left = false;
  if (e.key === 'ArrowRight') carrotState.keys.right = false;
}
function carrotMoveButton(dir) {
  if (!carrotGameRunning) return;
  if (dir==='left') carrotState.rabbitX -= carrotConfig.rabbitSpeed*2;
  if (dir==='right') carrotState.rabbitX += carrotConfig.rabbitSpeed*2;
  clampRabbit();
}
function clampRabbit() {
  if (carrotState.rabbitX < 0) carrotState.rabbitX = 0;
  if (carrotState.rabbitX + carrotConfig.rabbitWidth > carrotConfig.width)
    carrotState.rabbitX = carrotConfig.width - carrotConfig.rabbitWidth;
}

function updateCarrotGame() {
  if (!carrotGameRunning) return;
  if (carrotState.keys.left) carrotState.rabbitX -= carrotConfig.rabbitSpeed;
  if (carrotState.keys.right) carrotState.rabbitX += carrotConfig.rabbitSpeed;
  clampRabbit();

  for (let i=0;i<carrotObjects.length;i++) {
    const o = carrotObjects[i];
    o.y += o.vy;
  }

  const rx = carrotState.rabbitX;
  const ry = carrotState.rabbitY;
  const rw = carrotConfig.rabbitWidth;
  const rh = carrotConfig.rabbitHeight;

  for (let i=carrotObjects.length-1;i>=0;i--) {
    const o = carrotObjects[i];
    if (o.y > carrotConfig.height+40) {
      carrotObjects.splice(i,1);
      continue;
    }
    const overlap = !(o.x+o.w < rx || o.x > rx+rw || o.y+o.h < ry || o.y > ry+rh);
    if (overlap) {
      if (o.type === 'carrot') {
        carrotScore2 += 2;
      } else {
        carrotLives--;
        if (carrotLives < 0) carrotLives = 0;
      }
      carrotObjects.splice(i,1);
    }
  }
  if (carrotLives <= 0) {
    finishCarrotGame();
  } else {
    updateCarrotInfo();
  }
}

function drawCarrotGame(ctx) {
  if (!carrotGameRunning) return;
  const w = carrotConfig.width;
  const h = carrotConfig.height;
  ctx.clearRect(0,0,w,h);

  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,'#bbdefb');
  grad.addColorStop(1,'#64b5f6');
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,w,h);

  ctx.fillStyle = '#81c784';
  ctx.fillRect(0,h-40,w,40);

  const rx = carrotState.rabbitX;
  const ry = carrotState.rabbitY;
  const rw = carrotConfig.rabbitWidth;
  const rh = carrotConfig.rabbitHeight;

  if (images.rabbit && images.rabbit.complete) {
    ctx.drawImage(images.rabbit, rx, ry, rw, rh);
  } else {
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.ellipse(rx+rw/2, ry+rh/2, rw/2, rh/2, 0, 0, Math.PI*2);
    ctx.fill();
  }

  carrotObjects.forEach(o => {
    if (o.type === 'carrot') {
      if (images.carrot && images.carrot.complete) {
        ctx.drawImage(images.carrot, o.x, o.y, o.w, o.h);
      } else {
        ctx.fillStyle = '#ff9800';
        ctx.fillRect(o.x, o.y, o.w, o.h);
      }
    } else {
      if (images.brick && images.brick.complete) {
        ctx.drawImage(images.brick, o.x, o.y, o.w, o.h);
      } else {
        ctx.fillStyle = '#5d4037';
        ctx.fillRect(o.x, o.y, o.w, o.h);
      }
    }
  });
}

function updateCarrotInfo() {
  const info = document.getElementById('carrotInfo');
  if (info) info.textContent = `–û—á–∫–∏: ${carrotScore2} ‚Ä¢ –ñ–∏–∑–Ω–∏: ${carrotLives}`;
}
function stopCarrotGame() {
  carrotGameRunning = false;
  if (carrotLoopId) { clearInterval(carrotLoopId); carrotLoopId = null; }
  if (carrotSpawnId) { clearInterval(carrotSpawnId); carrotSpawnId = null; }
  window.removeEventListener('keydown', carrotKeyDown);
  window.removeEventListener('keyup', carrotKeyUp);
}
function finishCarrotGame() {
  if (!carrotGameRunning) return;
  carrotGameRunning = false;
  stopCarrotGame();
  const ch = getSelectedCharacter();
  if (!ch) return;
  const reward = Math.max(0, carrotScore2);
  if (reward > 0) {
    ch.coins = (ch.coins || 0) + reward;
    saveCharacters();
    updateCoinsLabel();
  }
  const info = document.getElementById('carrotInfo');
  if (info) info.textContent += ` ‚Ä¢ –ù–∞–≥—Ä–∞–¥–∞: +${reward} –º–æ–Ω–µ—Ç`;
}

/* –°–¢–ê–†–¢ –ò–ì–†–´ */
function startGame() {
  if (!currentUser) {
    alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å –∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.');
    return;
  }
  if (!selectedCharacterId) {
    alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ –±–∞–∑–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π.');
    showScreen('dbScreen');
    return;
  }
  activeLocation = 'farm';
  showScreen('gameScreen');
}

const regUsername = document.getElementById('regUsername');
const regEmail = document.getElementById('regEmail');
const regPassword = document.getElementById('regPassword');
const registerError = document.getElementById('registerError');
const registerForm = document.getElementById('registerForm');
const loginUsername = document.getElementById('loginUsername');
const loginPassword = document.getElementById('loginPassword');
const loginError = document.getElementById('loginError');
const loginForm = document.getElementById('loginForm');
const currentUserLabel = document.getElementById('currentUserLabel');
const logoutBtn = document.getElementById('logoutBtn');
const charactersBody = document.getElementById('charactersBody');
const charName = document.getElementById('charName');
const charClassInput = document.getElementById('charClass');
const charLevel = document.getElementById('charLevel');
const currentCharLabel = document.getElementById('currentCharLabel');
const coinsLabel = document.getElementById('coinsLabel');
const detailTitle = document.getElementById('detailTitle');
const detailContent = document.getElementById('detailContent');
const minigameTitle = document.getElementById('minigameTitle');
const minigameSubtitle = document.getElementById('minigameSubtitle');
const minigameArea = document.getElementById('minigameArea');
</script>

</body>
</html>
